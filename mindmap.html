<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markmap æ¨¹ç‹€æª¢è¦–å™¨ v1.1.0</title>
    <style>
        /* åŸºç¤æ¨£å¼å’Œä½ˆå±€ */
        body {
            margin: 0;
            display: flex;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #333;
            background-color: #fff;
            height: 100vh;
            overflow: hidden; /* é˜²æ­¢
            body 
            æ»¾å‹• 
            */
        }

        /* --- å´é‚Šæ¬„æ¨£å¼ (å¯æ»¾å‹•) --- */
        #sidebar {
            width: 320px; /* å´é‚Šæ¬„å¯¬åº¦ */
            min-width: 300px;
            height: 100vh;
            overflow-y: auto; /* åƒ…å´é‚Šæ¬„å¯æ»¾å‹• */
            border-right: 1px solid #e0e0e0;
            box-sizing: border-box;
            background-color: #f9f9f9;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            padding: 0;
        }

        #sidebar-header {
            padding: 20px 25px;
            margin: 0;
            color: #1a73e8;
            font-size: 1.25rem;
            border-bottom: 2px solid #1a73e8;
            background-color: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        #file-tree-container {
            padding: 10px 20px;
        }

        /* --- æ¨¹ç‹€æª¢è¦– (Tree View) æ¨£å¼ --- */
        .tree-node {
            list-style-type: none;
            margin: 2px 0;
        }

        /* å·¢ç‹€çš„ ULï¼Œå¢åŠ å·¦å´ç¸®æ’ */
        .tree-node ul {
            padding-left: 20px;
            margin: 5px 0 5px 12px;
            border-left: 1px dashed #ccc;
        }

        /* è³‡æ–™å¤¾ (å¯é»æ“Š) */
        .tree-folder-title {
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .tree-folder-title:hover {
            background-color: #e0e7ff;
        }

        /* è³‡æ–™å¤¾åœ–ç¤º (ç”¨æ–¼å±•é–‹/æ”¶é—”) */
        .tree-folder-title .icon {
            display: inline-block;
            width: 16px;
            text-align: center;
            margin-right: 5px;
            transition: transform 0.1s ease-in-out;
        }

        /* è³‡æ–™å¤¾æ”¶é—”æ™‚çš„åœ–ç¤º */
        .tree-node.collapsed > .tree-folder-title .icon {
            transform: rotate(-90deg);
        }

        /* è³‡æ–™å¤¾çš„å­é …ç›® (é è¨­éš±è—) */
        .tree-node.collapsed > ul {
            display: none;
        }

        /* æª”æ¡ˆ (å¯é»æ“Š) */
        .tree-file {
            display: block;
            padding: 5px 8px 5px 30px; /* ç¸®æ’æª”æ¡ˆä½¿å…¶å°é½Š */
            text-decoration: none;
            color: #444;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tree-file:hover {
            background-color: #e0e7ff;
            color: #1a73e8;
        }

        /* ç•¶å‰é¸ä¸­çš„æª”æ¡ˆ */
        .tree-file.active {
            font-weight: bold;
            background-color: #1a73e8;
            color: #ffffff;
            border-color: #1a73e8;
        }

        /* --- Markmap å®¹å™¨æ¨£å¼ --- */
        #markmap-container {
            flex-grow: 1;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        #markmap {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* è¼‰å…¥å’ŒéŒ¯èª¤æç¤º */
        .status-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            color: #777;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
        }
        .status-message.error {
            color: #D32F2F; /* ç´…è‰² */
        }
        
        .sidebar-status {
            padding: 20px;
            font-size: 1rem;
            color: #777;
        }
        .sidebar-status.error {
             color: #D32F2F;
        }

    </style>
</head>
<body>
    <div id="sidebar">
        <h3 id="sidebar-header">ğŸ“‚ ç­†è¨˜æª”æ¡ˆåˆ—è¡¨</h3>
        <div id="file-tree-container">
            <!-- æª”æ¡ˆæ¨¹å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
            <div class="sidebar-status" id="sidebar-status">æ­£åœ¨è¼‰å…¥...</div>
        </div>
    </div>
    <div id="markmap-container">
        <svg id="markmap"></svg>
        <div id="markmap-status" class="status-message">è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹ç­†è¨˜æª”æ¡ˆ</div>
    </div>
    
    <!-- å¼•å…¥ Markmap å¿…è¦å‡½å¼åº« (é€é CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.17"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.17"></script>

    <script>
        // =================================================================
        //                 ğŸ”” GitHub è³‡è¨Š (è«‹ä¿®æ”¹é€™è£¡) ğŸ””
        // =================================================================
        const GITHUB_USERNAME = 'klhrd';      
        const REPO_NAME = 'class_note';       
        const BRANCH_NAME = 'main'; // æˆ–æ˜¯ 'master'
        // =================================================================
        
        const MARKDOWN_EXTENSION = '.md';
        
        // Map ç”¨ä¾†å„²å­˜æª”æ¡ˆè·¯å¾‘åˆ° DOM å…ƒç´ çš„æ˜ å°„ï¼Œæ–¹ä¾¿æ¨£å¼æ§åˆ¶
        const fileLinksMap = new Map();
        // å„²å­˜ç•¶å‰æ´»å‹•çš„é€£çµ
        let activeLink = null;
        
        // Markmap å¯¦ä¾‹
        let mm; 

        // ====== 1. Markmap æ¸²æŸ“æ ¸å¿ƒå‡½å¼ (v1.1.0) ======
        /**
         * è¼‰å…¥ Markdown å…§å®¹ä¸¦æ¸²æŸ“ Markmapã€‚
         * @param {string} filePath - GitHub ä¸Šçš„æª”æ¡ˆè·¯å¾‘ (e.g., 'chinese/lesson1.md')
         * @param {HTMLElement} sourceLink - è§¸ç™¼æ¸²æŸ“çš„æª”æ¡ˆé€£çµ DOM å…ƒç´ 
         */
        async function renderMarkmap(filePath, sourceLink) {
            const markmapStatus = document.getElementById('markmap-status');
            const markmapEl = document.getElementById('markmap');
            
            // æ¸…ç©ºèˆŠçš„ Markmap (å¦‚æœå­˜åœ¨)
            if (mm) {
                mm.destroy();
                mm = null;
            }
            markmapEl.innerHTML = ''; // æ¸…ç©º SVG å…§å®¹
            markmapStatus.textContent = `æ­£åœ¨è¼‰å…¥ ${filePath} çš„å…§å®¹...`;
            markmapStatus.className = 'status-message'; // é‡è¨­æ¨£å¼
            markmapStatus.style.display = 'block';

            try {
                // ä½¿ç”¨ GitHub Raw å…§å®¹çš„ URL æ ¼å¼
                const rawFileUrl = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${REPO_NAME}/${BRANCH_NAME}/${filePath}`;
                
                const response = await fetch(rawFileUrl);
                if (!response.ok) {
                    throw new Error(`ç„¡æ³•è¼‰å…¥æª”æ¡ˆ (HTTP ${response.status})`);
                }
                const markdownContent = await response.text();
                
                const { transform } = window.markmap;
                // æª¢æŸ¥ Markdown å…§å®¹æ˜¯å¦ç‚ºç©º
                if (!markdownContent.trim()) {
                    throw new Error("æª”æ¡ˆå…§å®¹ç‚ºç©ºã€‚");
                }
                
                const { root, features } = transform(markdownContent);
                
                // æˆåŠŸè¼‰å…¥ï¼Œéš±è—ç‹€æ…‹æç¤º
                markmapStatus.style.display = 'none';
                
                // å»ºç«‹æ–°çš„ Markmap å¯¦ä¾‹
                mm = window.markmap.Markmap.create(markmapEl, null, root);
                
                // è™•ç† Hash èˆ‡æ¨£å¼æ›´æ–°
                if (sourceLink) {
                    if (activeLink) {
                        activeLink.classList.remove('active');
                    }
                    sourceLink.classList.add('active');
                    activeLink = sourceLink;
                    
                    // é€é history API éœé»˜æ›´æ–° URL Hash
                    history.pushState({ path: filePath }, null, `#${filePath}`);
                }

            } catch (error) {
                console.error("Markmap æ¸²æŸ“éŒ¯èª¤:", error);
                markmapStatus.textContent = `âŒ æ¸²æŸ“éŒ¯èª¤: ${error.message}`;
                markmapStatus.className = 'status-message error';
            }
        }

        // ====== 2. æª”æ¡ˆæ¨¹è³‡æ–™è™•ç† (v1.1.0) ======
        /**
         * é€é GitHub Git Trees API æŠ“å–å„²å­˜åº«çš„å®Œæ•´æª”æ¡ˆçµæ§‹ã€‚
         */
        async function fetchFileTree() {
            // ä½¿ç”¨ Git Trees API åŠ ä¸Š ?recursive=1 å¯ä»¥ä¸€æ¬¡æŠ“å–æ‰€æœ‰æª”æ¡ˆ
            const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/git/trees/${BRANCH_NAME}?recursive=1`;
            
            const response = await fetch(apiUrl);
            if (!response.ok) {
                throw new Error(`ç„¡æ³•å¾ GitHub API å–å¾—æª”æ¡ˆæ¨¹ (HTTP ${response.status})`);
            }
            const data = await response.json();
            
            if (data.truncated) {
                console.warn("GitHub API å›æ‡‰è¢«æˆªæ–·ï¼Œæª”æ¡ˆåˆ—è¡¨å¯èƒ½ä¸å®Œæ•´ã€‚");
            }
            
            // æˆ‘å€‘åªé—œå¿ƒ .md æª”æ¡ˆ
            return data.tree
                .filter(item => item.type === 'blob' && item.path.endsWith(MARKDOWN_EXTENSION))
                .map(item => item.path);
        }

        /**
         * å°‡æ‰å¹³çš„æª”æ¡ˆè·¯å¾‘åˆ—è¡¨è½‰æ›ç‚ºå·¢ç‹€çš„æ¨¹ç‹€çµæ§‹ã€‚
         * @param {string[]} paths - æª”æ¡ˆè·¯å¾‘åˆ—è¡¨
         * @returns {object} - æ¨¹ç‹€çµæ§‹çš„æ ¹ç¯€é»
         */
        function buildTree(paths) {
            const root = { name: 'root', type: 'tree', children: [] };

            paths.forEach(path => {
                const parts = path.split('/');
                let currentNode = root;

                parts.forEach((part, index) => {
                    let childNode = currentNode.children.find(n => n.name === part);
                    
                    const isFile = index === parts.length - 1;

                    if (!childNode) {
                        if (isFile) {
                            childNode = {
                                name: part,
                                type: 'blob',
                                path: path
                            };
                            currentNode.children.push(childNode);
                        } else {
                            // å»ºç«‹ä¸€å€‹è³‡æ–™å¤¾ç¯€é»
                            childNode = {
                                name: part,
                                type: 'tree',
                                path: parts.slice(0, index + 1).join('/'),
                                children: []
                            };
                            currentNode.children.push(childNode);
                        }
                    }
                    currentNode = childNode;
                });
            });
            
            // æ’åºï¼šè³‡æ–™å¤¾åœ¨æª”æ¡ˆä¹‹å‰ï¼Œç„¶å¾ŒæŒ‰åç¨±æ’åº
            const sortNodes = (nodes) => {
                nodes.sort((a, b) => {
                    if (a.type !== b.type) {
                        return a.type === 'tree' ? -1 : 1; // è³‡æ–™å¤¾å„ªå…ˆ
                    }
                    return a.name.localeCompare(b.name, 'zh-TW'); // æŒ‰åç¨±æ’åº
                });
                nodes.forEach(node => {
                    if (node.type === 'tree') {
                        sortNodes(node.children);
                    }
                });
            };
            
            sortNodes(root.children);
            return root;
        }

        // ====== 3. æ¸²æŸ“å´é‚Šæ¬„ (Tree View) (v1.1.0) ======
        /**
         * éè¿´å»ºç«‹æª”æ¡ˆæ¨¹çš„ DOM çµæ§‹ã€‚
         * @param {object} node - ç•¶å‰ç¯€é» (è³‡æ–™å¤¾æˆ–æª”æ¡ˆ)
         * @returns {HTMLLIElement} - å»ºç«‹çš„ list item å…ƒç´ 
         */
        function createTreeViewNode(node) {
            const li = document.createElement('li');
            li.className = 'tree-node';

            if (node.type === 'tree') {
                // --- é€™æ˜¯è³‡æ–™å¤¾ ---
                li.classList.add('collapsed'); // é è¨­æ”¶é—”
                
                const title = document.createElement('div');
                title.className = 'tree-folder-title';
                title.innerHTML = `<span class="icon">â–¶</span> <span>${node.name}</span>`;
                
                // é»æ“Šè³‡æ–™å¤¾æ¨™é¡Œæ™‚ï¼Œåˆ‡æ›æ”¶é—”ç‹€æ…‹
                title.addEventListener('click', (e) => {
                    e.stopPropagation(); // é˜²æ­¢è§¸ç™¼ä¸Šå±¤
                    li.classList.toggle('collapsed');
                });
                
                li.appendChild(title);

                const childrenUl = document.createElement('ul');
                node.children.forEach(child => {
                    childrenUl.appendChild(createTreeViewNode(child));
                });
                li.appendChild(childrenUl);

            } else if (node.type === 'blob') {
                // --- é€™æ˜¯æª”æ¡ˆ ---
                li.classList.add('tree-file-node');
                
                const link = document.createElement('a');
                link.className = 'tree-file';
                link.href = `#${node.path}`;
                link.textContent = `ğŸ“ ${node.name}`;
                link.dataset.path = node.path; // å„²å­˜è·¯å¾‘
                
                // é»æ“Šæª”æ¡ˆé€£çµæ™‚ï¼Œæ¸²æŸ“ Markmap
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    renderMarkmap(node.path, link);
                });
                
                li.appendChild(link);
                fileLinksMap.set(node.path, link); // å„²å­˜åˆ° Map ä¸­
            }
            return li;
        }

        /**
         * æ ¹æ“šè·¯å¾‘å°‹æ‰¾æª”æ¡ˆé€£çµï¼Œä¸¦è‡ªå‹•å±•é–‹å…¶æ‰€æœ‰çˆ¶è³‡æ–™å¤¾ã€‚
         * @param {string} path - æª”æ¡ˆè·¯å¾‘
         * @returns {boolean} - æ˜¯å¦æ‰¾åˆ°ä¸¦é¸ä¸­
         */
        function findAndSelectFile(path) {
            const link = fileLinksMap.get(path);
            if (!link) {
                return false;
            }

            // è§¸ç™¼æ¸²æŸ“
            renderMarkmap(path, link);
            
            // å‘ä¸Šéæ­· DOMï¼Œå±•é–‹æ‰€æœ‰çˆ¶è³‡æ–™å¤¾
            let currentNode = link.parentElement; // å¾ <li> é–‹å§‹
            while (currentNode && currentNode.id !== 'file-tree-container') {
                if (currentNode.tagName === 'LI' && currentNode.classList.contains('tree-node')) {
                    currentNode.classList.remove('collapsed'); // å±•é–‹
                }
                currentNode = currentNode.parentElement;
            }
            
            // æ²å‹•åˆ°æª¢è¦–ç¯„åœå…§
            link.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return true;
        }

        // ====== 4. åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ (v1.1.0) ======
        async function initializeApp() {
            const container = document.getElementById('file-tree-container');
            const statusEl = document.getElementById('sidebar-status');

            try {
                const paths = await fetchFileTree();
                
                if (paths.length === 0) {
                    throw new Error("å„²å­˜åº«ä¸­æ‰¾ä¸åˆ°ä»»ä½• .md æª”æ¡ˆã€‚");
                }
                
                const tree = buildTree(paths);

                // æ¸…ç©ºè¼‰å…¥æç¤º
                statusEl.remove();
                
                // å»ºç«‹æ ¹ UL
                const rootUl = document.createElement('ul');
                rootUl.style.paddingLeft = '0'; // æ ¹ç¯€é»ä¸éœ€è¦ç¸®æ’
                
                tree.children.forEach(node => {
                    rootUl.appendChild(createTreeViewNode(node));
                });
                
                container.appendChild(rootUl);

                // è™•ç†åˆå§‹è¼‰å…¥ (æª¢æŸ¥ URL Hash)
                const hashPath = window.location.hash.substring(1);
                let loaded = false;
                
                if (hashPath) {
                    loaded = findAndSelectFile(hashPath);
                }

                // å¦‚æœ Hash ç„¡æ•ˆæˆ–ä¸å­˜åœ¨ï¼Œå˜—è©¦è¼‰å…¥æ ¹ç›®éŒ„çš„ README.md
                if (!loaded) {
                    loaded = findAndSelectFile('README.md');
                }
                
                // å¦‚æœé‚„æ˜¯æ²’è¼‰å…¥ï¼Œè¼‰å…¥ç¬¬ä¸€å€‹æ‰¾åˆ°çš„æª”æ¡ˆ
                if (!loaded && fileLinksMap.size > 0) {
                    const firstFile = fileLinksMap.keys().next().value;
                    findAndSelectFile(firstFile);
                }

            } catch (error) {
                console.error("åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼éŒ¯èª¤:", error);
                statusEl.textContent = `âŒ è¼‰å…¥éŒ¯èª¤: ${error.message}`;
                statusEl.className = 'sidebar-status error';
            }
        }
        
        // ====== 5. è™•ç†ç€è¦½å™¨è¿”å›/å‰é€²æŒ‰éˆ• (popstate) ======
        window.addEventListener('popstate', (event) => {
            let path;
            if (event.state && event.state.path) {
                path = event.state.path;
            } else {
                path = window.location.hash.substring(1);
            }

            if (path) {
                findAndSelectFile(path);
            }
        });

        // é é¢è¼‰å…¥å¾Œï¼Œé–‹å§‹åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
